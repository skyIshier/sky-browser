var D=Object.defineProperty;var F=(t,e,n)=>e in t?D(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var c=(t,e,n)=>(F(t,typeof e!="symbol"?e+"":e,n),n);import{ba as I,r as d,q as m}from"./entry.BgnvDUI5.js";import{Z as B,B as E,a as A}from"./index._BGoy-tc.js";function l(t){return new Promise((e,n)=>{t.oncomplete=t.onsuccess=()=>e(t.result),t.onabort=t.onerror=()=>n(t.error)})}function g(t,e){const n=indexedDB.open(t);n.onupgradeneeded=()=>n.result.createObjectStore(e);const a=l(n);return(o,s)=>a.then(u=>s(u.transaction(e,o).objectStore(e)))}let w;function h(){return w||(w=g("keyval-store","keyval")),w}function C(t,e=h()){return e("readonly",n=>l(n.get(t)))}function b(t,e,n=h()){return n("readwrite",a=>(a.put(e,t),l(a.transaction)))}function R(t,e=h()){return e("readwrite",n=>(t.forEach(a=>n.put(a[1],a[0])),l(n.transaction)))}function k(t=h()){return t("readwrite",e=>(e.clear(),l(e.transaction)))}function $(t,e){return t.openCursor().onsuccess=function(){this.result&&(e(this.result),this.result.continue())},l(t.transaction)}function j(t=h()){return t("readonly",e=>{if(e.getAll)return l(e.getAll());const n=[];return $(e,a=>n.push(a.value)).then(()=>n)})}class M{constructor(e){c(this,"filename");c(this,"size");c(this,"cached");this.filename=e.filename,this.size=e.size,this.cached=e.cached}getDataView(){return this.getData().then(e=>new DataView(e))}async getData(){const e=await C(this.filename,v);if(e===void 0)throw new Error(`Missing value for key: "${this.filename}"`);return e}}function O(t){return console.log("unzip:",t.name,"byteLength:",t.size),new B(new E(t)).getEntriesGenerator()}class V{constructor(e,n,a){c(this,"entry");c(this,"filename");c(this,"size");c(this,"cached");c(this,"cacheFn");this.entry=e,this.filename=e.filename,this.size=e.uncompressedSize,this.cached=n,this.cacheFn=a}async getBuffer(){if(this.entry.getData===void 0)throw new Error(`Missing data in entry ${this.filename}!`);const e=new A,a=await(await this.entry.getData(e)).arrayBuffer();return await this.cacheFn(this,a),a}getDataView(){return this.getBuffer().then(e=>new DataView(e))}getData(){return this.getBuffer().then(e=>new Uint8Array(e))}}const z="skyCacheId",p=g("sky-meta","meta"),v=g("sky-buffer","apk");function y(t){return`${t.name}:${t.size}:${t.lastModified}`}function S(){return localStorage.getItem(z)||""}function G(t){localStorage.setItem(z,t)}async function P(t,e={}){var f;const n=S(),a=y(t);n!==a&&(e={});const o=await O(t),s={};for await(const r of o){const i=(f=e[r.filename])==null?void 0:f.cached;s[r.filename]=new V(r,i,H)}if(n===a)return s;G(a);const u=Object.values(s);return console.log(`cache ${u.length} file references...`),await R(u.map(r=>[r.filename,{filename:r.filename,size:r.size,cached:r.cached}]),p),console.log("cache done"),s}async function x(){const t=await j(p),e={};for(const n of t)e[n.filename]=new M(n);return e}async function H(t,e){t.cached=!0,console.log("write to cache:",t.filename,t.size),await Promise.all([b(t.filename,e,v),b(t.filename,{filename:t.filename,size:t.size,cached:t.cached},p)])}function W(){return Promise.all([k(v),k(p)])}const L=I("apkStore",()=>{const t=d(!1),e=d(S()),n=m(()=>e?e.value.split(":").shift():"no file"),a=d({}),o=d(!1),s=m(()=>o.value),u=m(()=>Object.keys(a.value)),f=m(()=>o.value?u.value:Object.values(a.value).filter(i=>i.cached).map(i=>i.filename));x().then(i=>{a.value=i,t.value=f.value.length===0});async function r(i){t.value=!1,a.value=await P(i,a.value),o.value=!0,e.value=y(i)}return{fileDropRequired:t,fileId:e,filename:n,apk:a,files:u,availableFiles:f,hasFile:s,clearCache:W,open:r}});export{L as u};
